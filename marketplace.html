<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SkillSwap | Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>body{font-family:'Inter',sans-serif}.brand-font{font-family:'Space Grotesk',sans-serif}</style>
</head>
<body class="bg-slate-950 text-white h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 border-r border-white/5 flex-col hidden md:flex">
        <div class="p-6">
            <div class="flex items-center gap-2 mb-8 text-2xl font-bold brand-font">
                <i class="fa-solid fa-bolt text-green-500"></i> SkillSwap
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-white/5 hover:text-white rounded-xl transition-all">
                    <i class="fa-solid fa-grid-2"></i> Dashboard
                </a>
                <a href="marketplace.html" class="flex items-center gap-3 px-4 py-3 bg-green-500/10 text-green-400 rounded-xl font-bold border-l-4 border-green-500">
                    <i class="fa-solid fa-store"></i> Marketplace
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-6 lg:p-10 relative">
        <header class="mb-8">
            <h2 class="text-2xl font-bold text-white">Marketplace</h2>
            <p class="text-slate-400">Find a mentor and book a session.</p>
        </header>

        <!-- Search -->
        <div class="relative max-w-xl mb-10">
            <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-500"></i>
            <input type="text" id="search-input" class="w-full bg-slate-900 border border-slate-700 rounded-xl pl-11 pr-4 py-3 text-white focus:border-green-500 outline-none" placeholder="Search by name or skill (e.g. 'Finance')...">
        </div>

        <!-- Grid -->
        <div id="mentors-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p class="text-slate-500 col-span-3 text-center py-10">Loading database...</p>
        </div>
    </main>

    <script type="module">
        import { auth, db, onAuthStateChanged, collection, getDocs, doc, updateDoc, getDoc } from './config.js';

        let currentUserUid = null;
        let currentUserCoins = 0;
        let allUsers = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                // Get current balance
                const snap = await getDoc(doc(db, "users", currentUserUid));
                currentUserCoins = snap.data().coins;
                loadMentors();
            } else {
                window.location.href = "auth.html";
            }
        });

        async function loadMentors() {
            const querySnapshot = await getDocs(collection(db, "users"));
            allUsers = [];
            querySnapshot.forEach((doc) => {
                if (doc.id !== currentUserUid) {
                    allUsers.push({ id: doc.id, ...doc.data() });
                }
            });
            renderGrid(allUsers);
        }

        function renderGrid(users) {
            const grid = document.getElementById('mentors-grid');
            grid.innerHTML = '';
            
            if(users.length === 0) {
                grid.innerHTML = `
                <div class="col-span-3 text-center p-10 border border-dashed border-slate-800 rounded-2xl">
                    <p class="text-slate-400 font-bold">No other students yet!</p>
                    <p class="text-slate-500 text-sm mt-2">Open an incognito window and sign up as a second user to test.</p>
                </div>`;
                return;
            }

            users.forEach(m => {
                const skillsHtml = (m.skills || []).map(s => `<span class="px-2 py-1 rounded bg-slate-800 text-slate-300 text-xs border border-slate-700">${s}</span>`).join('');
                const hasSkills = (m.skills && m.skills.length > 0);

                const card = document.createElement('div');
                card.className = "bg-slate-900/50 border border-white/5 rounded-2xl p-6 hover:border-green-500/50 transition-all flex flex-col justify-between";
                card.innerHTML = `
                    <div>
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-white text-sm">
                                ${m.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="font-bold text-white text-lg">${m.name}</h4>
                                <p class="text-xs text-slate-400">Student</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-6">
                            ${hasSkills ? skillsHtml : '<span class="text-xs text-slate-600">No skills listed</span>'}
                        </div>
                    </div>
                    <div class="pt-4 border-t border-white/5 flex items-center justify-between">
                        <div class="text-white font-bold">50 <span class="text-green-400 text-xs">SC</span></div>
                        <button class="book-btn bg-white text-slate-900 hover:bg-green-500 hover:text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">
                            Book
                        </button>
                    </div>
                `;
                
                card.querySelector('.book-btn').addEventListener('click', () => bookSession(m));
                grid.appendChild(card);
            });
        }

        async function bookSession(mentor) {
            const COST = 50;
            if (currentUserCoins >= COST) {
                if (confirm(`Confirm booking with ${mentor.name} for ${COST} SC?`)) {
                    // Deduct
                    await updateDoc(doc(db, "users", currentUserUid), { coins: currentUserCoins - COST });
                    
                    // Add to Mentor (Simple implementation)
                    const mentorRef = doc(db, "users", mentor.id);
                    const mentorSnap = await getDoc(mentorRef);
                    await updateDoc(mentorRef, { coins: mentorSnap.data().coins + COST });

                    alert(`Success! Session booked. Your new balance will reflect shortly.`);
                    window.location.reload();
                }
            } else {
                alert(`Insufficient Funds! You need ${COST} SC.`);
            }
        }

        document.getElementById('search-input').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.name.toLowerCase().includes(term) || 
                (u.skills && u.skills.some(s => s.toLowerCase().includes(term)))
            );
            renderGrid(filtered);
        });
    </script>
</body>
</html>
